{{ partial "head/head.html" . }}
    <body class="{{if .Site.Params.layoutReverse}}layout-reverse {{end}}{{if .Site.Params.dark_mode}}dark-theme{{end}}">
        <a href="#main-content" class="skip-link" data-i18n="skip_to_content">Skip to main content</a>
        <div class="wrapper">
            {{ partial "sidebar/sidebar.html" . }}
            <main class="content container" id="main-content">
                <div class="theme-toggle-wrapper">
                    <div class="mobile-header-bar">
                        <span class="mobile-title" data-i18n="site_title">Endo &amp; Adeno Resources</span>
                    </div>
                    <div class="header-cards" id="header-cards"></div>
                    <div class="theme-toggle" id="theme-toggle">
                        <button class="toggle-btn" id="toggle-theme-btn" title="Toggle light/dark mode" aria-label="Toggle light/dark mode" data-i18n="toggle_theme" data-i18n-attr="title,aria-label">
                            <svg class="toggle-icon sun-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                            <svg class="toggle-icon moon-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                        </button>
                    </div>
                </div>
                {{ block "main" . -}}{{- end }}
                <!-- Back to Top Button -->
                <button class="back-to-top" id="back-to-top" aria-label="Back to top" title="Back to top" data-i18n="back_to_top" data-i18n-attr="title,aria-label">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="18 15 12 9 6 15"></polyline>
                    </svg>
                </button>
            </main>
            {{ block "sidebar" . }}{{ end }}
        </div>
        <script>
        // Move resource cards into header bar
        (function() {
            var cards = document.querySelector('.resource-cards');
            var target = document.getElementById('header-cards');
            if (cards && target) {
                target.appendChild(cards);
            }
        })();

        // Back to Top
        (function() {
            var btn = document.getElementById('back-to-top');
            var container = document.querySelector('.content.container');
            if (!btn) return;
            var isMobile = window.innerWidth <= 768;

            function onScroll() {
                var scrollTop = isMobile
                    ? (window.pageYOffset || document.documentElement.scrollTop)
                    : (container ? container.scrollTop : 0);
                btn.classList.toggle('visible', scrollTop > 300);
            }

            if (isMobile) {
                window.addEventListener('scroll', onScroll);
            } else if (container) {
                container.addEventListener('scroll', onScroll);
            }

            btn.addEventListener('click', function() {
                if (isMobile) {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else if (container) {
                    container.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
        })();

        // Convert tables to accordion layout
        (function() {
            var tables = document.querySelectorAll('.content table');
            tables.forEach(function(table) {
                var thead = table.querySelector('thead');
                if (!thead) return;
                var headers = [];
                thead.querySelectorAll('th').forEach(function(th) {
                    headers.push(th.textContent.trim());
                });
                if (headers.length < 2) return;

                var container = document.createElement('div');
                container.className = 'table-accordion';

                var rows = table.querySelectorAll('tbody tr');
                rows.forEach(function(row) {
                    var cells = row.querySelectorAll('td');
                    if (!cells.length) return;

                    var details = document.createElement('details');
                    details.setAttribute('data-accordion', 'table');

                    var summary = document.createElement('summary');
                    summary.innerHTML = cells[0].innerHTML;
                    details.appendChild(summary);

                    if (cells.length > 1) {
                        var dl = document.createElement('dl');
                        dl.className = 'table-accordion-content';
                        for (var i = 1; i < cells.length; i++) {
                            var row_div = document.createElement('div');
                            row_div.className = 'table-accordion-row';
                            var dt = document.createElement('dt');
                            dt.textContent = headers[i] || '';
                            var dd = document.createElement('dd');
                            dd.innerHTML = cells[i].innerHTML;
                            row_div.appendChild(dt);
                            row_div.appendChild(dd);
                            dl.appendChild(row_div);
                        }
                        details.appendChild(dl);
                    }
                    container.appendChild(details);
                });

                if (container.children.length > 0) {
                    table.parentNode.replaceChild(container, table);
                }
            });
        })();

        // Expand all <details> sections by default (except Case Studies and table accordions)
        (function() {
            document.querySelectorAll('details').forEach(function(d) {
                if (d.hasAttribute('data-accordion')) return;
                var summary = d.querySelector('summary');
                if (summary && summary.textContent.indexOf('Case Stud') !== -1) return;
                d.setAttribute('open', '');
            });
        })();

        // Resource Card Filters + Sidebar Nav Filters
        (function() {
            var cards = document.querySelectorAll('.resource-card[data-filter]');
            var sidebarLinks = document.querySelectorAll('[data-sidebar-filter]');
            var panels = document.querySelectorAll('.filter-panel[data-panel]');
            var homeDefault = document.getElementById('home-default');
            var featuredVideo = document.getElementById('featured-video');
            if (!panels.length) return;

            var activeFilter = null;

            function applyFilter(filter) {
                // Toggle off if already active
                if (activeFilter === filter) {
                    activeFilter = null;
                    cards.forEach(function(c) {
                        c.classList.remove('card-active');
                        c.setAttribute('aria-pressed', 'false');
                    });
                    sidebarLinks.forEach(function(l) { l.classList.remove('active'); });
                    panels.forEach(function(p) { p.style.display = 'none'; });
                    if (homeDefault) homeDefault.style.display = '';
                    if (featuredVideo) featuredVideo.style.display = '';
                    return;
                }

                activeFilter = filter;

                // Update card button states
                cards.forEach(function(c) {
                    c.classList.remove('card-active');
                    c.setAttribute('aria-pressed', 'false');
                });
                var matchingCard = document.querySelector('.resource-card[data-filter="' + filter + '"]');
                if (matchingCard) {
                    matchingCard.classList.add('card-active');
                    matchingCard.setAttribute('aria-pressed', 'true');
                }

                // Update sidebar link states
                sidebarLinks.forEach(function(l) { l.classList.remove('active'); });
                var matchingLink = document.querySelector('[data-sidebar-filter="' + filter + '"]');
                if (matchingLink) matchingLink.classList.add('active');

                // Show matching panel, hide others
                panels.forEach(function(p) {
                    p.style.display = p.getAttribute('data-panel') === filter ? '' : 'none';
                });
                if (homeDefault) homeDefault.style.display = 'none';
                if (featuredVideo) featuredVideo.style.display = 'none';

                // Scroll to content below sticky header
                var target = document.getElementById('filtered-content');
                var container = document.querySelector('.content.container');
                if (target && container) {
                    var headerHeight = document.querySelector('.theme-toggle-wrapper').offsetHeight;
                    var targetTop = target.offsetTop - headerHeight - 8;
                    container.scrollTo({ top: targetTop, behavior: 'smooth' });
                }

                // Close mobile menu if open
                var sidebar = document.getElementById('sidebar');
                var menuBtn = document.getElementById('mobile-menu-btn');
                var overlay = document.getElementById('mobile-overlay');
                if (sidebar && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                    if (menuBtn) { menuBtn.classList.remove('active'); menuBtn.setAttribute('aria-expanded', 'false'); }
                    if (overlay) overlay.classList.remove('active');
                }
            }

            cards.forEach(function(card) {
                card.addEventListener('click', function() {
                    applyFilter(this.getAttribute('data-filter'));
                });
            });

            sidebarLinks.forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    applyFilter(this.getAttribute('data-sidebar-filter'));
                });
            });
        })();

        // Mobile Menu Toggle
        (function() {
            var btn = document.getElementById('mobile-menu-btn');
            var sidebar = document.getElementById('sidebar');
            var overlay = document.getElementById('mobile-overlay');
            if (!btn || !sidebar) return;

            function toggleMenu() {
                var isOpen = sidebar.classList.toggle('open');
                btn.classList.toggle('active');
                if (overlay) overlay.classList.toggle('active');
                btn.setAttribute('aria-expanded', isOpen);
            }

            btn.addEventListener('click', toggleMenu);
            if (overlay) overlay.addEventListener('click', toggleMenu);
        })();

        // Client-side Search
        (function() {
            var searchInput = document.getElementById('search-input');
            var resultsContainer = document.getElementById('search-results');
            if (!searchInput || !resultsContainer) return;

            var searchIndex = null;

            function loadIndex() {
                if (searchIndex !== null) return Promise.resolve(searchIndex);
                return fetch('{{ "index.json" | absURL }}')
                    .then(function(r) { return r.json(); })
                    .then(function(data) { searchIndex = data; return data; });
            }

            function search(query) {
                if (!searchIndex || !query) { resultsContainer.innerHTML = ''; return; }
                var q = query.toLowerCase();
                var results = searchIndex.filter(function(page) {
                    return (page.title && page.title.toLowerCase().indexOf(q) !== -1) ||
                           (page.summary && page.summary.toLowerCase().indexOf(q) !== -1) ||
                           (page.content && page.content.toLowerCase().indexOf(q) !== -1) ||
                           (page.tags && page.tags.some(function(t) { return t.toLowerCase().indexOf(q) !== -1; }));
                }).slice(0, 5);

                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-no-results">No results found</div>';
                    return;
                }

                resultsContainer.innerHTML = results.map(function(r) {
                    return '<a class="search-result-item" href="' + r.permalink + '">' +
                           '<span class="search-result-title">' + r.title + '</span>' +
                           '</a>';
                }).join('');
            }

            var debounceTimer;
            searchInput.addEventListener('input', function() {
                var q = this.value.trim();
                clearTimeout(debounceTimer);
                if (q.length < 2) { resultsContainer.innerHTML = ''; return; }
                debounceTimer = setTimeout(function() {
                    loadIndex().then(function() { search(q); });
                }, 200);
            });

            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    this.value = '';
                    resultsContainer.innerHTML = '';
                }
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.sidebar-search')) {
                    resultsContainer.innerHTML = '';
                }
            });
        })();

        // i18n Translation System
        (function() {
            var translations = null;
            var currentLang = localStorage.getItem('site-language') || 'en';

            function applyTranslations(lang) {
                if (!translations || !translations[lang]) return;
                var t = translations[lang];
                document.querySelectorAll('[data-i18n]').forEach(function(el) {
                    var key = el.getAttribute('data-i18n');
                    if (!t[key]) return;
                    var attrs = el.getAttribute('data-i18n-attr');
                    if (attrs) {
                        attrs.split(',').forEach(function(attr) {
                            el.setAttribute(attr.trim(), t[key]);
                        });
                    } else {
                        el.textContent = t[key];
                    }
                    // Handle separate aria-label key
                    var ariaKey = el.getAttribute('data-i18n-aria');
                    if (ariaKey && t[ariaKey]) {
                        el.setAttribute('aria-label', t[ariaKey]);
                    }
                });
                // Update no-results text if visible
                var noResults = document.querySelector('.search-no-results');
                if (noResults && t.no_results) noResults.textContent = t.no_results;
                // Handle RTL for Arabic
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                // Sync picker
                var picker = document.getElementById('lang-picker');
                if (picker) picker.value = lang;
                currentLang = lang;
                localStorage.setItem('site-language', lang);
            }

            fetch('/i18n/translations.json')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    translations = data;
                    applyTranslations(currentLang);
                    var picker = document.getElementById('lang-picker');
                    if (picker) {
                        picker.value = currentLang;
                        picker.addEventListener('change', function() {
                            applyTranslations(this.value);
                        });
                    }
                });
        })();

        // Custom Theme Toggle
        (function() {
            var btn = document.getElementById('toggle-theme-btn');
            if (!btn) return;
            var sunIcon = btn.querySelector('.sun-icon');
            var moonIcon = btn.querySelector('.moon-icon');

            // Restore saved theme
            var saved = localStorage.getItem('theme');
            if (saved === 'dark') {
                document.body.classList.add('dark-theme');
            } else if (saved === 'light') {
                document.body.classList.remove('dark-theme');
            }

            function updateIcons() {
                var isDark = document.body.classList.contains('dark-theme');
                sunIcon.style.display = isDark ? 'none' : 'block';
                moonIcon.style.display = isDark ? 'block' : 'none';
            }

            btn.addEventListener('click', function() {
                document.body.classList.toggle('dark-theme');
                var isDark = document.body.classList.contains('dark-theme');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                updateIcons();
            });

            updateIcons();
        })();
        </script>
    </body>
</html>
