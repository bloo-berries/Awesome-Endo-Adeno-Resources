{{ partial "head/head.html" . }}
    <body class="{{if .Site.Params.layoutReverse}}layout-reverse {{end}}{{if .Site.Params.dark_mode}}dark-theme{{end}}">
        <a href="#main-content" class="skip-link">Skip to main content</a>
        <div class="wrapper">
            {{ partial "sidebar/sidebar.html" . }}
            <main class="content container" id="main-content">
                <div class="theme-toggle-wrapper">
                    <div class="header-cards" id="header-cards"></div>
                    {{ partial "light_dark.html" . }}
                </div>
                {{ block "main" . -}}{{- end }}
                <!-- Back to Top Button -->
                <button class="back-to-top" id="back-to-top" aria-label="Back to top" title="Back to top">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="18 15 12 9 6 15"></polyline>
                    </svg>
                </button>
            </main>
            {{ block "sidebar" . }}{{ end }}
        </div>
        <script>
        // Move resource cards into header bar
        (function() {
            var cards = document.querySelector('.resource-cards');
            var target = document.getElementById('header-cards');
            if (cards && target) {
                target.appendChild(cards);
            }
        })();

        // Back to Top
        (function() {
            var btn = document.getElementById('back-to-top');
            var container = document.querySelector('.content.container');
            if (!btn || !container) return;
            container.addEventListener('scroll', function() {
                btn.classList.toggle('visible', container.scrollTop > 300);
            });
            btn.addEventListener('click', function() {
                container.scrollTo({ top: 0, behavior: 'smooth' });
            });
        })();

        // Heading Anchor Links
        (function() {
            var headings = document.querySelectorAll('.content h1[id], .content h2[id], .content h3[id], .content h4[id], .content h5[id], .content h6[id]');
            headings.forEach(function(h) {
                var link = document.createElement('a');
                link.className = 'heading-anchor';
                link.href = '#' + h.id;
                link.setAttribute('aria-label', 'Link to ' + h.textContent);
                link.textContent = '#';
                h.appendChild(link);
            });
        })();

        // Resource Card Filters + Sidebar Nav Filters
        (function() {
            var cards = document.querySelectorAll('.resource-card[data-filter]');
            var sidebarLinks = document.querySelectorAll('[data-sidebar-filter]');
            var panels = document.querySelectorAll('.filter-panel[data-panel]');
            var homeDefault = document.getElementById('home-default');
            var featuredVideo = document.getElementById('featured-video');
            if (!panels.length) return;

            var activeFilter = null;

            function applyFilter(filter) {
                // Toggle off if already active
                if (activeFilter === filter) {
                    activeFilter = null;
                    cards.forEach(function(c) {
                        c.classList.remove('card-active');
                        c.setAttribute('aria-pressed', 'false');
                    });
                    sidebarLinks.forEach(function(l) { l.classList.remove('active'); });
                    panels.forEach(function(p) { p.style.display = 'none'; });
                    if (homeDefault) homeDefault.style.display = '';
                    if (featuredVideo) featuredVideo.style.display = '';
                    return;
                }

                activeFilter = filter;

                // Update card button states
                cards.forEach(function(c) {
                    c.classList.remove('card-active');
                    c.setAttribute('aria-pressed', 'false');
                });
                var matchingCard = document.querySelector('.resource-card[data-filter="' + filter + '"]');
                if (matchingCard) {
                    matchingCard.classList.add('card-active');
                    matchingCard.setAttribute('aria-pressed', 'true');
                }

                // Update sidebar link states
                sidebarLinks.forEach(function(l) { l.classList.remove('active'); });
                var matchingLink = document.querySelector('[data-sidebar-filter="' + filter + '"]');
                if (matchingLink) matchingLink.classList.add('active');

                // Show matching panel, hide others
                panels.forEach(function(p) {
                    p.style.display = p.getAttribute('data-panel') === filter ? '' : 'none';
                });
                if (homeDefault) homeDefault.style.display = 'none';
                if (featuredVideo) featuredVideo.style.display = 'none';

                // Scroll to content below sticky header
                var target = document.getElementById('filtered-content');
                var container = document.querySelector('.content.container');
                if (target && container) {
                    var headerHeight = document.querySelector('.theme-toggle-wrapper').offsetHeight;
                    var targetTop = target.offsetTop - headerHeight - 8;
                    container.scrollTo({ top: targetTop, behavior: 'smooth' });
                }

                // Close mobile menu if open
                var sidebar = document.getElementById('sidebar');
                var menuBtn = document.getElementById('mobile-menu-btn');
                var overlay = document.getElementById('mobile-overlay');
                if (sidebar && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                    if (menuBtn) { menuBtn.classList.remove('active'); menuBtn.setAttribute('aria-expanded', 'false'); }
                    if (overlay) overlay.classList.remove('active');
                }
            }

            cards.forEach(function(card) {
                card.addEventListener('click', function() {
                    applyFilter(this.getAttribute('data-filter'));
                });
            });

            sidebarLinks.forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    applyFilter(this.getAttribute('data-sidebar-filter'));
                });
            });
        })();

        // Mobile Menu Toggle
        (function() {
            var btn = document.getElementById('mobile-menu-btn');
            var sidebar = document.getElementById('sidebar');
            var overlay = document.getElementById('mobile-overlay');
            if (!btn || !sidebar) return;

            function toggleMenu() {
                var isOpen = sidebar.classList.toggle('open');
                btn.classList.toggle('active');
                if (overlay) overlay.classList.toggle('active');
                btn.setAttribute('aria-expanded', isOpen);
            }

            btn.addEventListener('click', toggleMenu);
            if (overlay) overlay.addEventListener('click', toggleMenu);
        })();

        // Client-side Search
        (function() {
            var searchInput = document.getElementById('search-input');
            var resultsContainer = document.getElementById('search-results');
            if (!searchInput || !resultsContainer) return;

            var searchIndex = null;

            function loadIndex() {
                if (searchIndex !== null) return Promise.resolve(searchIndex);
                return fetch('{{ "index.json" | absURL }}')
                    .then(function(r) { return r.json(); })
                    .then(function(data) { searchIndex = data; return data; });
            }

            function search(query) {
                if (!searchIndex || !query) { resultsContainer.innerHTML = ''; return; }
                var q = query.toLowerCase();
                var results = searchIndex.filter(function(page) {
                    return (page.title && page.title.toLowerCase().indexOf(q) !== -1) ||
                           (page.summary && page.summary.toLowerCase().indexOf(q) !== -1) ||
                           (page.content && page.content.toLowerCase().indexOf(q) !== -1) ||
                           (page.tags && page.tags.some(function(t) { return t.toLowerCase().indexOf(q) !== -1; }));
                }).slice(0, 5);

                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-no-results">No results found</div>';
                    return;
                }

                resultsContainer.innerHTML = results.map(function(r) {
                    return '<a class="search-result-item" href="' + r.permalink + '">' +
                           '<span class="search-result-title">' + r.title + '</span>' +
                           '</a>';
                }).join('');
            }

            var debounceTimer;
            searchInput.addEventListener('input', function() {
                var q = this.value.trim();
                clearTimeout(debounceTimer);
                if (q.length < 2) { resultsContainer.innerHTML = ''; return; }
                debounceTimer = setTimeout(function() {
                    loadIndex().then(function() { search(q); });
                }, 200);
            });

            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    this.value = '';
                    resultsContainer.innerHTML = '';
                }
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.sidebar-search')) {
                    resultsContainer.innerHTML = '';
                }
            });
        })();
        </script>
    </body>
</html>
